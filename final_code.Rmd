---
title: "Logistic Regression and Propensity Score Matching Analysis of Canadians and Flu Shots from the 2017-2018 Canadian Commmunity Health Survey"
author: "Linhan Zhang 1004734353"
date: "14/12/2020"
output:
    pdf_document:
header-includes:
 \usepackage{float}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

# Abstract
  The goal of this study was to evaluate the factors which affected Canadian influenza vaccination rates and determine whether education is a factor which causes increased/decreased vaccination. The methods include a logistic regression model evaluating multiple factors and their association with whether an individual received a flu shot within the past year and a propensity score matching analysis of the observational data. First, the data for both analysis were retrieved as subsets of the CCHS; cleaned by removing NAs, renaming variables, and redefining age and vaccination categories; and finally the logistic regression model data was split into training (75%) and testing (25%). Subsequently, a logistic model was created using forward selection. The final model included variables sex, marital status, age, education, and access to health care. Diagnostics through internal validation revealed a mean square error of 0.003 and an AUC of 0.6855 as well as a prediction error of 1.207982 through the testing data. The PSM revealed that education is a significant predictor of whether someone has had their flu shot within the last year. This suggests first and foremost that improvements can be made in public health education. Through this analysis, health experts will be able to target those less likely to get their flu shot either through education, outreach, or additional incentives; subsequently, these measures would be crucial in maintaining public health and ensuring high quality of life in Canada.

(Github link:https://github.com/Linlinzhang28/STA304_Final_Project.git)
  
##### Keywords:
logistic regression, propensity score matching, flu shots, Canada, Canadian Community Health Survey, Education, population health, health, influenza, vaccination

# Introduction

  The influenza is a common, epidemic, respiration illness which is caused by a virus (Dickin et al., 2017). Each year, there are estimated more than 12, 200 hospitalization cases and 3500 deaths caused by the influenza in Canadian communities which puts elderly people and those with chronic conditions at great risk (Dickin et al., 2017). The most effective way of preventing the spread of the influenza is through getting the vaccination before each flu season. Indeed, the government shows that vaccination can prevent up to 60% of the population from getting the flu (Ministry of Health, 2020). However, data from the Canadian Community Health Survey 2017-2018 (CCHS) illustrates that only 56.6% of the people within the last year have gotten their shot and 32.5% of the people have not gotten any flu shots for more than 2 years (Health Statistics Division, 2017). Studies conducted in the United States have found that factors such as race, gender, side effect concerns, lack of knowledge of the ingredients in a flu vaccine all exert significant effects on influenza vaccination rate (Zimmerman et al., 2003). 

  This study aims to find out what factors affect the Canadian influenza vaccination rate by using a logistic regression model. Accordingly, variables are selected through the CCHS from 2017-2018 (Health Statistics Division, 2017). This model will specifically examine the factors which are associated with the likelihood of not having any flu shots within the past year. Further, a propensity score matching analysis will also be conducted to explore any possible causal relationships between variables of interest and flu shot data (Caetano, 2020a). This tool, popularized since the 1980s, allows causal inferences to be made from observational data under specific circumstances. That is, by matching observations based on a variety of covariates, differences between treatment and outcome groups are essentially adjusted for, thereby creating a pseudo-randomized sample from observational data for analysis. In this analysis, the outcome variable of interest will also be whether the individual had any flu shots in the past year, however, the main treatment variable of interest is education. That is, it is hypothesized that non-belief in the benefits or effectiveness of vaccines is what causes most to forego the shot. Overall, this study will point to factors of focus that need to be addressed to improve Canadian vaccination rates. Also, by identifying factors associated with decreased vaccination, Health Canada will also be able to implement improvements to their current policies and vaccination outreach and practices.

  Two data sets will be employed throughout the analysis, though both are subsets of the 2017-2018 CCHS (Health Statistics Division, 2017). The first data set will be used in the main logistic regression analysis of factors associated with lack of flu shots within the past year, while the second data set will be used in the propensity score matching analysis. This report will overview the methodologies by highlighting the important aspects of the CCHS and its data and the process of creating the model. Then the results of the study will be presented and a discussion on the meaning of the results will follow. Finally, the limitations and improvements as well as possible future steps will be explored and reasoned. An appendix is included at the end and will provide supplemental details, plots, graphs, and calculations relevant to the analysis.
  
# Methodology

## Data

 The two data sets for the logistic regression analysis and PSM of this study were retrieved as subsets from the 2017-2018 CCHS and contained sex, age, education, marital status, last time had flu shot, access to health care, health insurance coverage, and income (Health Statistics Division, 2017). The Canadian Community Health Survey is a cross sectional survey which attempts to collect a sample representative of the Canadian population (Health Statistics Division, 2017). To achieve this, they weigh populations by their respective size in Canada and sample accordingly. Generally, the CCHS aims to collect 130,000 responses of which 10,000 from teens aged between 12 and 17 years. While the target population is all Canadians, the sampling frame excludes full-time members of the Canadian Armed Forces, institutionalized people, children in foster homes, and people living in special Quebec health regions; though altogether, these populations represent less than 3% of Canada's population (Health Statistics Division, 2017). Overall, the major strengths include the large sample size, which are well weighted to represent the Canadian population, and the large number of variables measured; however, major weaknesses lie in their low response rate which can skew their population weights. Indeed, no methodology regarding how non-response was treated was provided; this may affect how well the final data sample represents Canada.

  The variables selected for the data were hypothesized to be associated with variability in likelihood of people getting their flu shots. The data set used for the main analysis and construction of the logistic regression initially comprised of 113,290 observations of 12 variables. These main variables from both raw data subsets were plotted and visualized in Appendix 1. Most trends in the raw data do not appear unusual; perhaps the most notable is the fact that a large majority of the respondents reported having no difficulty accessing health care. Nonetheless, all these variables will undergo cleaning and will be part of the analysis. However, during the data cleaning process, observations were removed for NA responses and 3 variables were removed because they were not analyzable in the logistic regression. In fact, those variables were answers to secondary questions regarding flu shots and were therefore not relevant. After cleaning there were 63,980 observations of 8 variables. Finally, within the predictor variable, 'last time had flu shot', the response category 'within last 1 year' was codified to the value '1' while all other levels of response ('more than 1 year but less than 2 years' and 'more than 2 years ago') were codified to the value '0' for the logistic regression. This was done to simplify the data and make the response variable more precise since the point of interest is what currently affects flu shot rates. Table 1 below presents the baseline characteristics of the subjects from the first data set. Moreover, this first data set was also separated into training and testing sections by 0.75 and 0.25 proportions respectively.

```{r,include=FALSE}
#load library
library(tidyverse)
library(foreign)
#load data
library(broom)
dataset = read.dta("/Users/linlinzhang/Desktop/linlin.dta")
```
```{r,include=FALSE}
#data cleaning
#check nas
sum(is.na(dataset$DHH_SEX))
sum(is.na(dataset$DHHGMS))
sum(is.na(dataset$DHHGAGE))
sum(is.na(dataset$EHG2DVR3))
sum(is.na(dataset$FLU_005))
sum(is.na(dataset$FLU_010))
sum(is.na(dataset$FLU_025B))
sum(is.na(dataset$FLU_025E))
sum(is.na(dataset$FLU_025J))
dataset <- subset(dataset, select = -c(FLU_025B))
dataset <- subset(dataset, select = -c(FLU_025E))
dataset <- subset(dataset, select = -c(FLU_025J))
sum(is.na(dataset$DOACC))
sum(is.na(dataset$DOINS))
sum(is.na(dataset$INCDGHH))
```
```{r,include=FALSE}
library(plyr)
#Rename the columns
dataset = dataset%>%
  rename(c('DHH_SEX' = 'Sex',
         'DHHGMS' = 'Marital.status',
         'DHHGAGE' = 'Age',
         'EHG2DVR3' = 'Education',
         'FLU_005' = 'Had.flu.shot.lifetime',
         'FLU_010' = 'Last.time.had.flu.shot',
         'DOACC' = 'Access.to.health.care',
         'DOINS' = 'Health.insurance.coverage',
         'INCDGHH' = 'Income'))
detach("package:plyr", unload=TRUE)
dataset = subset(dataset, select = -Had.flu.shot.lifetime)
```
```{r,include=FALSE}
#make some plot to view the data
P1 =ggplot(data = dataset, aes(x = Last.time.had.flu.shot ))+geom_bar()
P2 =ggplot(data = dataset, aes(x = Sex ))+geom_bar()
P3 = ggplot(data = dataset, aes(x = Marital.status))+geom_bar()
P4=ggplot(data = dataset, aes(x = Age ))+geom_bar()
P5=ggplot(data = dataset, aes(x = Education))+geom_bar()
P6=ggplot(data = dataset, aes(x = Access.to.health.care ))+geom_bar()
P7=ggplot(data = dataset, aes(x = Health.insurance.coverage ))+geom_bar()
P8=ggplot(data = dataset, aes(x = Income))+geom_bar()
```
```{r,include=FALSE}
dataset = na.omit(dataset)
#arrange response levels
levels(dataset$Last.time.had.flu.shot)[levels(dataset$Last.time.had.flu.shot)=="Less than 1 year ago"] <- 1
levels(dataset$Last.time.had.flu.shot)[levels(dataset$Last.time.had.flu.shot)=="1 year to less than 2 years ago"] <- 0
levels(dataset$Last.time.had.flu.shot)[levels(dataset$Last.time.had.flu.shot)=="2 years ago or more"] <- 0
#age
levels(dataset$Age)[levels(dataset$Age)=='Age between 12 and 14'] <- 'Adolescence'
levels(dataset$Age)[levels(dataset$Age)=='Age between 15 and 17'] <- 'Adolescence'
levels(dataset$Age)[levels(dataset$Age)=='Age between 18 and 19'] <- 'Adolescence'
levels(dataset$Age)[levels(dataset$Age)=='Age between 20 and 24'] <- 'Young Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 25 and 29'] <- 'Young Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 30 and 34'] <- 'Young Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 35 and 39'] <- 'Young Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 40 and 44'] <- 'Middle-aged Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 45 and 49'] <- 'Middle-aged Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 50 and 54'] <- 'Middle-aged Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 55 and 59'] <- 'Middle-aged Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 60 and 64'] <- 'Old Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 65 and 69'] <- 'Old Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 70 and 74'] <- 'Old Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age between 75 and 79'] <- 'Old Adult'
levels(dataset$Age)[levels(dataset$Age)=='Age 80 and older'] <- 'Old Adult'
```
```{r,echo=FALSE, warning=FALSE}
library(tableone)
variables <- c("Sex", "Marital.status", "Age", "Education",
               "Last.time.had.flu.shot", "Access.to.health.care",
               "Health.insurance.coverage","Income")
cat.variables <- c("Sex", "Marital.status", "Age", "Education",
               "Last.time.had.flu.shot", "Access.to.health.care",
               "Health.insurance.coverage","Income")
t1 <- CreateTableOne(variables, dataset, cat.variables, 
                     strata = c("Last.time.had.flu.shot"))
kableone(t1, caption = 'Baseline Characteristics Table LRM')
```
  
  Subsequently, the data used for propensity score matching originally contained 113,290 observations of 9 variables. After cleaning out the NA responses, there were 61,780 observations remaining. This time however, the response variable of interest (outcome) was 'does not believe benefits'. The 'does not believe benefits' is a variable derived from those who responded 'no' to having taken the current flu shots. In this category not believing in the benefits was codified as 0 while the opposite as 1. The baseline characteristics of the subjects in this data set are presented in Table 2 below. 

```{r,include=FALSE}
#separate training and testing set
library(caTools)
set.seed(100)
dt = sort(sample(nrow(dataset), nrow(dataset)*.75))
train =dataset[dt,]
test =dataset[-dt,]
```
```{r,include=FALSE}
#build the logistic model
library(MASS)
#chi-sqare test for the first variable Sex and flu shot
chisq.test(dataset$Last.time.had.flu.shot, dataset$Sex)
#
model1 <- glm(Last.time.had.flu.shot~Sex,family = binomial, 
                  data = train)
#add variables
model2 <- glm(Last.time.had.flu.shot~Sex+
                Marital.status,family = binomial, 
                  data = train)
anova(model1, model2, test = 'Chisq')#add marital status
model3 <-  glm(Last.time.had.flu.shot~Sex+
                Marital.status+ Age,family = binomial, 
                  data = train)
anova(model2, model3, test = 'Chisq')#add age
model4 <-  glm(Last.time.had.flu.shot~Sex+
                Marital.status+ Age+ Education,family = binomial, 
                  data = train)
anova(model3, model4, test = 'Chisq')#add education
model5 <-  glm(Last.time.had.flu.shot~Sex+
                Marital.status+ Age+ Education+
                 Access.to.health.care,family = binomial, 
                  data = train)

anova(model4, model5, test = 'Chisq')#add access to health care
model6 <-  glm(Last.time.had.flu.shot~Sex+
                Marital.status+ Age+ Education+
                 Access.to.health.care+Health.insurance.coverage,
               family = binomial, data = train)
anova(model5, model6, test = 'Chisq')#does not include health insurance coverage
model7 <-  glm(Last.time.had.flu.shot~Sex+
                Marital.status + Age+ Education+
                 Access.to.health.care+Income,family = binomial, 
                  data = train)
anova(model5, model7, test = 'Chisq') #does not add income
```
```{r,include=FALSE}
#final model
final_mod = glm(Last.time.had.flu.shot~Sex+
                Marital.status+ Age+ Education+
                 Access.to.health.care,family = binomial, 
                  data = train)
broom::tidy(final_mod)
```
```{r,include=FALSE}
#Validate the model
#Internal Validation
library(rms)
logit.mod <- lrm(formula = as.numeric(train$Last.time.had.flu.shot)~Sex+Age+Marital.status+Education+Access.to.health.care,data = train, x = TRUE, y = TRUE, model = T)
## Cross validation ##
cross.calib <- calibrate(logit.mod, method="crossvalidation", B = 10)
plot(cross.calib, las = 1, xlab = 'Predicted Probability')
```
```{r, include=FALSE}
#roc curve
library(pROC)
par(pty = "s")
roc(train$Last.time.had.flu.shot, final_mod$fitted.values, 
    plot = T, legacy.axes = T,percentage = T, xlab = "False Positive Percentage",
    ylab = "True Positive Percentage", col = "#377eb8", lwd = 4)
```
```{r,include=FALSE}
##Validating on the test data
test$logodds <-
  final_mod%>%
  predict(newdata = test)
test$estimate <- exp(test$logodds)/(1+exp(test$logodds))
mean((test$estimate - as.numeric(test$Last.time.had.flu.shot))^2)
```
```{r,include=FALSE}
#propensity score matching
data.m =  read.dta("/Users/linlinzhang/Desktop/linlin2.dta")
#clean data
library(plyr)
#Rename the columns
data.m = data.m%>%
  rename(c('GEO_PRV' = 'Province',
          'DHH_SEX' = 'Sex',
         'DHHGMS' = 'Marital.status',
         'DHHDGLVG' = 'Family.arrangement',
         'DHHGAGE' = 'Age',
         'EHG2DVR3' = 'Education',
         'ALCDVTTM' = 'Type.of.drinker',
         'FLU_025I' = 'Does.not.believe.benefits',
         'INCDGPER' = 'Income'))
detach("package:plyr", unload=TRUE)
```
```{r,include=FALSE}
data.m = na.omit(data.m)
#Education
levels(data.m$Education)[levels(data.m$Education)=='Less than secondary school graduation'] <- 0
levels(data.m$Education)[levels(data.m$Education)=='Secondary school graduation, no post-secondary education'] <- 0
levels(data.m$Education)[levels(data.m$Education)=='Post-secondary certificate diploma or univ degree'] <- 1
#age
levels(data.m$Age)[levels(data.m$Age)=='Age between 12 and 14'] <- 'Adolescence'
levels(data.m$Age)[levels(data.m$Age)=='Age between 15 and 17'] <- 'Adolescence'
levels(data.m$Age)[levels(data.m$Age)=='Age between 18 and 19'] <- 'Adolescence'
levels(data.m$Age)[levels(data.m$Age)=='Age between 20 and 24'] <- 'Young Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 25 and 29'] <- 'Young Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 30 and 34'] <- 'Young Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 35 and 39'] <- 'Young Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 40 and 44'] <- 'Middle-aged Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 45 and 49'] <- 'Middle-aged Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 50 and 54'] <- 'Middle-aged Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 55 and 59'] <- 'Middle-aged Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 60 and 64'] <- 'Old Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 65 and 69'] <- 'Old Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 70 and 74'] <- 'Old Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age between 75 and 79'] <- 'Old Adult'
levels(data.m$Age)[levels(data.m$Age)=='Age 80 and older'] <- 'Old Adult'
```
```{r,echo=FALSE, warning=FALSE}
#other table1
variables2 <- c('Province',"Sex", "Marital.status",'Family.arrangement',"Age",
                "Type.of.drinker", "Does.not.believe.benefits",
               "Health.insurance.coverage","Income")
cat.variables2 <- c('Province',"Sex", "Marital.status",'Family.arrangement',"Age",
                "Type.of.drinker", "Does.not.believe.benefits",
               "Health.insurance.coverage","Income")
t1.2 <- CreateTableOne(variables2, data.m, cat.variables2, 
                     strata = c("Education"))
kableone(t1.2,caption = 'Baseline Characteristics Table PSM')
```
  
  Finally, the age category in both data sets were widened to 4 levels: 12-19 years (Adolescence), 20-39 years (Young Adult), 40-59 years (Middle-aged Adult), and 60 and older (Old Adult).


  
## Models

### Logistic Regression Model
  
  The logistic regression model was built and run in R. A binary logistic regression model was chosen because the variables were categorical, meaning that other models like linear regression would be meaningless if applied to the data (Caetano, 2020b). Since the response variable was simplified to '0' or '1' levels, the model is binary representing two levels of the response variable. Specifically, this model was built using forward selection. The first step included using Chi-square tests to evaluate the first and foremost significant variable correlated with flu shots within the past year (Wiley & Wiley, 2019). As detailed in Appendix 2, the variable sex was significant and was added to the model. Then other variables of interest were added step-wise, first starting with marital status; then using an ANOVA test the significance of marital status in the model was determined (Appendix 3). In this case, a conventional significance level of 0.05 was used. This process was repeated for the other variables (age, education, access to health care, health insurance coverage, and income). The results of each step's ANOVA test are detail in Appendix 3 (Wiley & Wiley, 2019). The final model included variables age, sex, education, marital status, and access to health care. The formula for the final model is:
\begin{gather*}
\widehat{log(\frac{Pr(Last.time.have.flu.shot = 1)}{Pr(Last.time.have.flu.shot = 0})}=\\
-0.316-0.204*Marital.status_{Common-law}+0.197*Marital.status_{Widowed/Divorced/Separated}\\
+0.260*Marital.status_{Single}+0.284*Age_{Young.adult}-0.008*Age_{Middle-aged.adult}\\
-1.208*Age_{Old.adult}+0.198*Education_{Secondary.school.graduation.no.post-secondary.education}\\
0.052*Education_{Post-secondary.certificate.diploma.or.univ.degree}+0.239*Access.to.health.care_{no.difficulties}
\end{gather*}

  The formula illustrates each predictor's coefficient (Appendix 4). A coefficient details the magnitude of the change in the likelihood of the response variable when all other factors remain equal. For example, OldAdult has a coefficient of -1.206729 compared to Young Adult with a coefficient of 0.284098. What these mean is that, when all other factors are equal, adults in the old category have higher log odds of not believing in the benefits of the flu shot as negative coefficients bring the overall value closer to '0'.

  The model was first diagnosed using cross-validation a technique used to test the model by using different samples of data (Stefan, 2020). The training set contained 75% of the observations while the testing set contained the remaining 25% of the observations. The cross-validation checks if the model predicts well for training data set. Essentially, this tool validates the accuracy of the model's predictions. The calibration plot (Appendix 5) shows that the bias-corrected line closely follows the ideal line which suggests that the model performs strongly to predict responses internally. Then, an area under the curve (AUC) also aids in assessing the performance of the model. This specific tool is used because it is created for instances where predictors are ordinal, a type of categorical data (Agresti, 2014, Wiley & Wiley, 2019). The AUC of the model, in Appendix 6, is 0.6855. Finally, a prediction error was calculated using the testing data to be 1.207982 (Appendix 7).

### Propensity Score Regression (PSR)
  
  PSR unlike the logistic regression analysis looks to evaluate causality between treatment and outcome (Caetano, 2020a). While the earlier model evaluated the associations between several factors and decreased vaccination rates, this propensity score regression aims to establish whether our treatment, in this case education, is a significant predictor of refusal to vaccinate due to the belief that there are no actual benefits to the flu shot. The code from this analysis is retrieved partially from Alexander. Essentially, PSR adjusts for differences between two groups and aims to highlight the true 'treatment effect'. These two analyses together provide a foundation of evidence upon which government and health experts can develop strategies to increase vaccination rate and trust in vaccinations. This part of the analysis relied on the second data set in which education was the treatment and belief that vaccinations are not effective is the outcome. In the propensity score matching there were 47,816 matches generated. The final propensity model is:

\begin{gather*}
\widehat{y}=2.018-0.37*Province_{Prince.Edward.Island}-0.063*Province_{Nova.Scotia}-0.0.086*Province_{Brunswick}\\-0.106*Province_{Quebec}-0.066*Province_{Ontario}-0.0.034*Province_{Manitoba}\\-0.030*Province_{Saskachewan}-0.069*Province_{Alberta}-0.047*Province_{British.Columbia}\\-0.068*Province_{Yukon}-0.054*Province_{Northwest.Territories}\\-0.003*Province_{Nunavut}-0.015*Sex_{Female}0.01*Marital.status_{Common-law}\\-0.013*Marital.status_{Widowed/Divorced/Separated}-0.01*Marital.status_{Single}\\+0.007*Family.arrangement_{Unattached.individual.living.with.others}\\-0.018*Family.arrangement_{individual.living .with.spouse/partner.and.children}\\-0.012*Family.arrangement_{Single.parent.living.with.children}\\+0.03*Family.arrangement_{Children.living.with.a.single.parent.with.or.without.siblings}\\-0.012*Family.arrangement_{Other}-0.025*Age_{Young.adult}-0.08*Age_{Middle-aged.adult}\\-0.098*Age_{Old.adult}-0.004*Type.of.drinker_{Occasional.drinker}\\+0.012*Type.of.drinker_{did.not.drink.in.the.last.12.month}-0.026*Income_{less.than.20,000}\\-0.028*Income_{20,000.to.39,999}-0.027*Income_{40,000-59,000}\\-0.031*Income_{60,000-79,000}-0.029*Income_{80,000.and.more}\\-0.019*Education_{1}
\end{gather*}

  The output from this model summarized will provide information regarding the significance of the predictors. Should education be a significant factor then, it would be suggested that lack of education can cause people to not believe in the benefits of vaccinations.
  
# Results

Through the first part of the analysis, the table summary of the logistic regression model (Appendix 4) highlights interesting correlations to vaccination within the past year. The table shows the coefficients of each level of each categorical variable. Larger positive values indicate greater likelihood of having gotten a vaccine in the past year and larger negative numbers indicate greater chance of not having gotten any flu shot in the past year. First, most noticeably, the population of older aged adults (60 years and older) are significantly more likely to have not gotten their vaccination within the past year with a coefficient of -1.206729. Furthermore, all marital statuses are positively associated with having gotten the flu shot with the coefficients varying between 0.196808 and 0.376134; women are less likely to have gotten a shot with a coefficient of -0.203871; those with no difficulty accessing health care are more likely to have gotten a shot with a coefficient of 0.238615. Finally, between education levels, surprisingly those with secondary education only or lower have almost 4 times the likelihood of having gotten a vaccination within the past year compared to those with post-secondary education (coefficients are 0.198286 and 0.051684 respectively). Overall, most variables lean in one direction over another however the magnitudes are not very large. The most interesting associations are those regarding older age adults and education levels.

  Finally, through the propensity score regression analysis, as illustrated in Appendix 8, education1 is a significant predictor (-0.19) of whether individuals believe in the benefits of vaccination. However, education1 refers to those with post-secondary education and the effect direction is negative meaning that the results suggest that higher education tends to cause individuals to not believe in the benefits of flu shots. 

# Discussion

## Summary

  This study was conducted on subsets of data from the 2017-2018 Canadian Community Health Survey (Health Statistics Division, 2017). For the first part, variables of interest for the logistic regression model predicting whether an individual had a flu shot within the past  year included age, sex, access to health care, health insurance coverage, income, education, and marital status. The data cleaning process removed many NA responses, re-organized the time of last flu shot variable, and re-defined the age variable into four more general levels. For the final model though, only age, sex, marital status, education, and access to health care were included. Then a propensity score matching analysis and regression was conducted on the second subset of data. In this analysis, education was the treatment variable and the outcome variable was whether individuals believed in the benefits of flu shots. Finally, it was determined that education is a significant predictor of whether an individual believes in the benefits of flu shots; however, the 'treatment effect' was in the opposite hypothesized direction and the 'effect size' was not very large.

## Conclusions

  In the first part of the study, a logistic model predicting the likelihood of an individual having gotten a flu shot within the past year was created. The most notable variables and levels included older aged adults, education, and access to health care. That is while marital status and sex had significant results, the variation between those of different marital statuses did not differ drastically. Moreover, women had just slight higher likelihood of not having gotten a flu shot in the past year. Nonetheless, it was evident that older aged adults had drastically higher chances of not having been vaccinated within the last year. This is especially concerning given that the older population suffers more from chronic diseases and is generally more compromised when it comes to community flu outbreaks. This variability could be explained by the fact that elderly people may have diminished connection to their greater communities and therefore are not aware of vaccination campaigns; another aspect which may influence their vaccination rate is the fact that many may not have the physical ability or resources to travel and have their flu shots each year. Similarly, no difficulty with access to health care was associated with greater likelihood of receiving a flu shot. These results, in tandem, may suggest that improvements must be made in health care accessibility and community outreach for the elderly. 
  
  Finally, the education variable was surprising since lower education levels were associated with greater likelihood of having received a vaccination within the past year. While many often assume the higher educated must be more aware and have greater critical thinking when it comes to the science of vaccinations, this assumption appears to be false and misleading. A reason for this is that education is not correlated with higher vaccination rates since not everyone attends higher education institutions in immunology and sciences, therefore there is no reason for higher education to be associated with greater scientific understanding which would propel individuals to get vaccinated. Overall, education at all levels are associated with slightly greater vaccination rates; however, for public health officials, it is important to note that to increase the effectiveness of schooling, it may be important to implement more pro-vaccination courses or modules into all levels of education since the magnitude of the positive coefficients of education were still small. Nonetheless, based on the first part of this study, it becomes apparent that improvements can be made in Canada to improve vaccination rates; indeed, starting with increasing community outreach and health care accessibility is crucial in taking care of Canada's aging population. Then, it would be important to focus on addressing the limitations of the current education system regarding public health practices like getting the flu shot. 

  Subsequently, in the propensity score regression, it was determined that education is a significant predictor of whether an individual believes in the benefits of the flu shot; however, similarly to the first part of the study, it was determined that higher education causes individuals to not believe in the benefits of the vaccine. These results, though surprising, again highlight a new aspect to consider. Indeed, those with higher education should not, in society, be granted 'a pass' and assumed to be conforming to proper public health practices just because they have a degree in higher education. Nonetheless, it is not important to dwell on the minor differences in the vaccination rates of those with different aquired education. What is more relevant is an evaluation of the effectiveness of education in informing Canadians on the importance of getting their flu shot. Indeed, in both the analyses the magnitude of the effects of education on vaccination are not very large. This should be an area of focus for Health Canada. While Canadians undergo their general education and highschool, they should be specifically informed on proper practices like getting the flu shot. The ideal observation in the Canadian population is that all those who have gotten their education in Canada have high vaccination rates. Of course there would still be other factors like those previously mentioned concerning accessibility and outreach; however, education is a low cost and effective area to start.
  
## Limitations and Next Steps

 First, though the CCHs is a very comprehensive survey, asking a wide variety of questions and presenting over 1000 variables, many of these variables do not have enough responses. Indeed, some variables though very interesting and relevant to this study like the frequency of doctor visits. A variable such as this one could be strongly associated with Canadian vaccination rates and could have provided important insight alongside access to health care variable; also, information could have given more context regarding where the government needs to improve in order to increase vaccination rates. Without many of these more precise measurements, this study is only able to draw general conclusions and inferences. Another limitation of this study is the somewhat arbitrary definition of the levels of certain categories like the age brackets. While the survey had responses from people as young as 12 and as old as 80+, this analysis used 4 age brackets to cover everyone. This reduces the meaning of many associations and conclusions because of how broad the categories are. However, this was necessary in order to evaluate categorical variables. Finally, in the propensity score matching analysis, while there were over 40,000 matches, the number of covariates that were adjusted for, again, was relatively small. This, though due to the reduced number of variables with sufficient observations is also due to a fundamental weakness of propensity score matching. Indeed, using too many variables will reduce the effectiveness of the matching. However, too few also weakens the strength of the results.

  Overall, this study incorporated many methods into its analysis, though for the future many improvements could be made. First, given the size of the sample, more variables could be considered for the model to make associations. This would also rely on improved responses from the survey. It is suggested that questions be made clearer or the survey be conducted in modules in order to increase the response rate to each question (e.g. it may be easier for a person to respond to all the health care questions if they were asked together and not rushed). Of course, in the future, a more meaningful propensity score matching analysis is due and this should be accomplished by including more covariates into the matching process, other important variables to consider could include more specific education levels, cultural background, religious beliefs, health conditions (which may limit vaccine accessibility like allergies). Ultimately, Health Canada should understand the results of this current study and begin forming and implementing changes in order to encourage Canadians to get their flu shot.

```{r,include=FALSE}
#logistic model
model = glm(Education ~Province+Sex+
                Marital.status+Family.arrangement+ Age+ Type.of.drinker+Income
            ,family = binomial, 
                  data = data.m)
stepAIC(model, direction = 'backward')
```
```{r,include=FALSE}
propensity_score <- glm(Education ~Province+Sex+
                Marital.status+Family.arrangement+ Age+ Type.of.drinker+Income
            ,family = binomial, 
                  data = data.m)
data.m <- 
  augment(propensity_score, 
          data = data.m,
          type.predict = "response") %>% 
  dplyr::select(-.resid, -.std.resid, -.hat, -.sigma, -.cooksd) 
data.m<- 
  data.m%>% 
  arrange(.fitted, Education)
data.m$treated <- 
  if_else(data.m$Education == 0, 0, 1)
data.m$treated <- 
  as.integer(data.m$treated)
matches <- arm::matching(z = data.m$treated, 
                         score = data.m$.fitted)
data.m<- cbind(data.m, matches)

data.matched <- 
  data.m %>% 
  filter(match.ind != 0) %>% 
  dplyr::select(-match.ind, -pairs, -treated)
head(data.matched)
propensity_score_regression <- 
lm(as.numeric(Does.not.believe.benefits) ~ Province+Sex+
                Marital.status+Family.arrangement+ Age+ Type.of.drinker+Income+Education, 
                data = data.m)
tab = huxtable::huxreg(propensity_score_regression)
```
\newpage
# References

Agresti, A. (2014). Categorical Data Analysis. Hoboken: Wiley.

Alexander, R. (11 November 2020). Running Through a Propensity Score Matching Example. Retrieved from: https://q.utoronto.ca/courses/184060/files/10649324?module_item_id=1998838
Caetano, S. J. (2020a). STA304 Propensity Score Matching. [Handout]. Retrieved 
from: https://q.utoronto.ca/courses/184060/files/9632737?module_item_id=1891982

Caetano, S. J. (2020b). STA304  Logistic Regression Intro. [Handout]. Retrieved 
from: https://q.utoronto.ca/courses/184060/files/9632737?module_item_id=1891982

Dickin, J.,, & Bailey, P.,, & James-Abra, E., Influenza (Flu) in Canada (2017). In The Canadian Encyclopedia. Retrieved from: https://www.thecanadianencyclopedia.ca/en/article/influenza

Health Statistics Division. (2017). Canadian community health survey, 2017-2018: Annual component Health Statistics Division, Statistics Canada. Retrieved
from http://odesi.ca/#/details?uri=/odesi/cchs-82M0013-E-2017-2018-Annual- component.xml

Ministry of Health. (2020). Flu shot safety and effectiveness. Retrieved from:
https://www.ontario.ca/page/flu-vaccine-safety-effectiveness

Stefan, G. (2020). STA303/STA1002: Methods of Data Analysis II Lecture 6 [PowerPoint slides]. Retrieved from: https://q.utoronto.ca/courses/159686/modules

Zimmerman, R. K., Santibanez, T. A., Janosky, J. E., Fine, M. J., Raymund, M., Wilson, S.A.,... Nowalk, M. P. (2003). What affects influenza vaccination rates among older patients? an analysis from inner-city, suburban, rural, and veterans affairs practices. The American Journal of Medicine, 114(1), 31-38. doi:10.1016/S0002-9343(02)01421-3




\newpage
## Appendix {-}

### Appendix 1
```{r, echo=FALSE, fig.cap = "Distribution for Last.time.had.flu.shot"}
P1+theme(axis.text = element_text(size = 5))
```

```{r, echo=FALSE, fig.cap = 'Distribution for Sex'}
P2
```

```{r, echo=FALSE, fig.cap = 'Distribution for Marital.Status'}
P3+theme(axis.text = element_text(size = 5))
```

```{r, echo=FALSE, fig.cap = 'Distribution for Age'}
P4+theme(axis.text = element_text(size = 5, angle = 90))
```

```{r, echo=FALSE, fig.cap = 'Distribution for Education'}
P5+theme(axis.text = element_text(size = 5,angle = 90))
```

```{r, echo=FALSE, fig.cap = 'Distribution for Access to Health Care'}
P6
```

```{r, echo=FALSE, fig.cap = 'Distribution for Health Insurance Coverage'}
P7
```

```{r, echo=FALSE, fig.cap = 'Distribution for Income'}
P8+theme(axis.text = element_text(size = 5, angle = 90))
```
\newpage

### Appendix 2

```{r,echo=FALSE}
library(knitr)
chi_result <- matrix(c('2.2e-16'), nrow  = 1, byrow = FALSE)
colnames(chi_result) <- c("Last.time.had.flu.shot")
rownames(chi_result)<-c('Sex')
kable(chi_result, caption = 'Associations between Last.time.had.flu.shot and Sex')
```

### Appendix 3

```{r, echo=FALSE}
anova.1 <- matrix(c('2.2e-16', '2.2e-16','5.423e-11','2.413e-08','0.2115','0.2533'),ncol=1, nrow =6 ,byrow=TRUE)
colnames(anova.1) <- c("P Value")
rownames(anova.1)<-c("Add Marital.Status","Add Age","Add Education", 'Add Access to Health Care', 'Add Health Insurance Coverage', 'Income')
kable(data.frame(anova.1), caption = 'P Values from the Chi-Square Tests')
```

### Appendix 4

```{r, echo=FALSE}
sum_t = broom::tidy(final_mod)
kable(data.frame(sum_t), caption = 'Summary Table for Final Model')
```

### Appendix 5

```{r,echo=FALSE}
#Validate the model
#Internal Validation
library(rms)
logit.mod <- lrm(formula = as.numeric(train$Last.time.had.flu.shot)~Sex+Age+Marital.status+Education+Access.to.health.care,data = train, x = TRUE, y = TRUE, model = T)
## Cross validation ##
cross.calib <- calibrate(logit.mod, method="crossvalidation", B = 10)
plot(cross.calib, las = 1, xlab = 'Predicted Probability')
```
\newpage

### Appendix 6

```{r, echo=FALSE,fig.align='center', message = FALSE}
#roc curve
library(pROC)
par(pty = "s")
q = roc(train$Last.time.had.flu.shot, final_mod$fitted.values, 
    plot = T, legacy.axes = T,percentage = T, xlab = "False Positive Percentage",
    ylab = "True Positive Percentage", col = "#377eb8", lwd = 4, auc = T)
q$auc
```

### Appendix 7

```{r}
##Validating on the test data
test$logodds <-
  final_mod%>%
  predict(newdata = test)
test$estimate <- exp(test$logodds)/(1+exp(test$logodds))
mean((test$estimate - as.numeric(test$Last.time.had.flu.shot))^2)
```
\newpage
### Appendix 8

```{r, echo=FALSE}
kable(tab)
```

